<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>日程調整 通知設定</title>
  <link rel="manifest" href="./manifest.json">
  <style>
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans JP',sans-serif;margin:16px}
    label{display:block;margin:8px 0}
    button{padding:8px 12px}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <h2>ブラウザ通知の設定</h2>
  <p class="muted">承認依頼・確定通知をスマホにもプッシュで送ります。iOSはホーム画面追加後に許可。 </p>

  <label>あなたのメールアドレス
    <input id="email" type="email" placeholder="you@example.com" autocomplete="email">
  </label>
  <button id="btn">通知を有効化</button>
  <div id="msg" class="muted" style="margin-top:8px"></div>

  <script>
    // ★ ここを自分の値に置換する
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwDX9Y7RosUVhyb1HckX8cXH1YWttZ5IXcMuuk6EWF5lSc3-GCY9rX4J_CpDwQJRb8W/exec";
    const VAPID_PUBLIC = "BJzWWnlyNjQ6gd1j--BFvRSLDfTrTI2zYfen_QGu3u_jdjF7RkneatRwyvSFGivudTImy6j8Pe_yP8hRX7yMF8E"; // web-pushで生成したPublic Key

    const $ = s => document.querySelector(s);
    const msg = t => $('#msg').textContent = t;

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    async function enablePush() {
      const email = $('#email').value.trim();
      if (!email) return msg('メールを入れてください');

      if (!('serviceWorker' in navigator)) return msg('Service Worker未対応のブラウザです');
      if (!('PushManager' in window)) return msg('Push API未対応のブラウザです');

      const reg = await navigator.serviceWorker.register('./sw.js');
      const perm = await Notification.requestPermission();
      if (perm !== 'granted') return msg('通知が許可されませんでした');

      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC)
      });

      // GASへ購読登録。preflight回避のため text/plain + no-cors。
      await fetch(`${GAS_URL}?action=subscribe`, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify({ email, subscription: sub })
      });

      msg('購読を登録しました。承認/確定のタイミングで通知が届きます。');
    }

    $('#btn').addEventListener('click', () => {
      enablePush().catch(e => msg('失敗: ' + (e?.message || e)));
    });
  </script>
</body>
</html>
